# Oylapi Endpoints 11-15 Implementation Plan

This file covers endpoints 11-15 from `agent-context/oyl-api.ts`, building on indices and rules established in `context/oylapi-migration-endpoints/1-5.md` and `context/oylapi-migration-endpoints/6-10.md`.

Assumptions from 1-5.md and 6-10.md (already implemented/approved):

- Ammdata owns canonical quotes and TOKEN/USD candles; prices are USD-only and all percent fields are multiplied by 100.
- Ammdata maintains `pool_creation_info` with creator ScriptPubKey taken from the protostone pointer output (LP receiver). If missing, fallback is acceptable but should not be relied on for correctness.
- Ammdata maintains `pools` (market defs), `factory_pools`, `pool_factory`, and pool-level activity logs.
- Oylapi should only call module-owned getters; storage.rs composes results.

---

### /get-pool-swap-history

#### Goal

Return swap history for a single pool, along with pool name and paging metadata.

#### Coverage

- Partially supported: ammdata activity exists per pool, but does not contain swap-specific fields (sold/bought token ids, address) required by `SwapHistoryItem`.
- Needs a swap-specific event index or an extended activity schema.

#### Inputs and validation

- `poolId` required.
- `count` defaults to 50, clamp 1..200.
- `offset` defaults to 0.
- `successful` defaults to false (if supported).
- `includeTotal` defaults to true.

#### Primary data sources (existing)

- Ammdata:
  - `activity:v1` (pool activity log) for swap events.
  - `pools` (market defs) for token0/token1 ids.
- Essentials:
  - `get_creation_record` for token labels to build pool name.

#### New indices required (and where)

- Ammdata:
  - `pool_swaps/v1/<pool_id>/<ts>/<seq> -> SwapEventRecord` (swap-only events).
  - `pool_swaps/count/<pool_id> -> u64` (optional for O(1) totals; can reuse activity trade counts if compatible).

Suggested `SwapEventRecord` fields:
- `txid` (32 bytes, BE for hex display)
- `timestamp` (u64)
- `pool_id`
- `sold_token` + `bought_token` (SchemaAlkaneId)
- `sold_amount` + `bought_amount` (u128 raw alks)
- `address_spk` (Vec<u8> scriptPubKey; address derived in oylapi)
- `success` (bool)

#### Implementation plan (write path)

1. While indexing activity, detect swaps (TradeBuy/TradeSell) and derive sold/bought tokens:
   - TradeSell (base in, quote out): sold = base, bought = quote.
   - TradeBuy (quote in, base out): sold = quote, bought = base.
2. Record sold/bought amounts using `abs(base_delta)` and `abs(quote_delta)`.
3. Derive address from protostone pointer output if available; store scriptPubKey bytes.
4. Write `pool_swaps` record (append-only) and update count.
5. Only write successful swaps (ignore reverted traces), or include `success` flag if storing both.

#### Implementation plan (read path)

1. Validate `poolId` and pagination params.
2. Fetch pool name using `pools` + token labels.
3. Read `pool_swaps` index by prefix, apply `offset` and `count`.
4. Map each record to `SwapHistoryItem`:
   - `transactionId` from txid.
   - `pay`/`receive` from sold/bought token ids and amounts.
   - `address` from scriptPubKey (if missing, use empty string).
   - `timestamp` as ISO string.
5. Return `PoolSwapHistoryResult` with `total` if `includeTotal` is true.

#### Missing getters to add (oylapi module)

- `get_pool_swap_history(pool_id, count, offset, include_total, successful?)`.
- `get_pool_name(pool_id)` (shared with /get-pool-details).

#### Caveats

- If address cannot be derived, return empty string in `address` fields.
- If total count is expensive without a count index, ignore `includeTotal` or return 0.

---

### /get-token-swap-history

#### Goal

Return swap history for a token across all pools.

#### Coverage

- Not supported without a token-based swap index; scanning all pools is O(n) and too slow.

#### Inputs and validation

- `tokenId` required.
- `count` defaults to 50, clamp 1..200.
- `offset` defaults to 0.
- `successful` defaults to false (if supported).
- `includeTotal` defaults to true.

#### Primary data sources (existing)

- None sufficient for fast access.

#### New indices required (and where)

- Ammdata:
  - `token_swaps/v1/<token_id>/<ts>/<seq> -> SwapEventRecord`.
  - `token_swaps/count/<token_id> -> u64`.

#### Implementation plan (write path)

1. When writing `pool_swaps`, also write a copy to `token_swaps` for both tokens in the swap.
2. Use the same `SwapEventRecord` schema for easy reuse.

#### Implementation plan (read path)

1. Validate `tokenId` and pagination params.
2. Read `token_swaps` by prefix; page by `offset`/`count`.
3. Map to `AmmSwapHistoryItem`:
   - Use sold/bought token ids and amounts.
   - Include pool ids if stored.
4. Return total if `includeTotal` is true.

#### Missing getters to add (oylapi module)

- `get_token_swap_history(token_id, count, offset, include_total, successful?)`.

#### Caveats

- If pool id is not stored in `SwapEventRecord`, omit `poolBlockId`/`poolTxId`.

---

### /get-pool-mint-history

#### Goal

Return liquidity add (mint) events for a pool.

#### Coverage

- Partially supported: activity has `LiquidityAdd` events but lacks token0/token1 amounts, lpTokenAmount, and address.

#### Inputs and validation

- `poolId` required.
- `count` defaults to 50, clamp 1..200.
- `offset` defaults to 0.
- `successful` defaults to false (if supported).
- `includeTotal` defaults to true.

#### Primary data sources (existing)

- Ammdata activity for liquidity adds.
- Ammdata `pools` for token0/token1 ids.
- Essentials `get_creation_record` for token ids when needed.

#### New indices required (and where)

- Ammdata:
  - `pool_mints/v1/<pool_id>/<ts>/<seq> -> MintEventRecord`.
  - `pool_mints/count/<pool_id> -> u64`.

Suggested `MintEventRecord` fields:
- `txid`, `timestamp`, `pool_id`
- `token0_id`, `token1_id`
- `token0_amount`, `token1_amount` (u128 raw alks)
- `lp_token_amount` (u128)
- `address_spk` (Vec<u8>)
- `success` (bool)

#### Implementation plan (write path)

1. Detect `LiquidityAdd` activity per pool at index time.
2. Derive token amounts from activity deltas (base/quote deltas).
3. Derive `lp_token_amount` by reading the pool token balance delta for the LP recipient (same transaction), or by using the net change in pool LP supply for that tx.
4. Derive address from protostone pointer output if available; store scriptPubKey bytes.
5. Write a `pool_mints` record and update count.

#### Implementation plan (read path)

1. Validate `poolId` and pagination params.
2. Read `pool_mints` index; map to `AmmMintHistoryItem`:
   - Token ids from record.
   - Amounts as strings.
   - Address from scriptPubKey (empty string if unknown).
   - Timestamp as ISO.
3. Return `total` if `includeTotal` is true.

#### Missing getters to add (oylapi module)

- `get_pool_mint_history(pool_id, count, offset, include_total, successful?)`.

#### Caveats

- If LP token amount cannot be derived per tx, set `lpTokenAmount = "0"` and document missing data.

---

### /get-pool-burn-history

#### Goal

Return liquidity remove (burn) events for a pool.

#### Coverage

- Partially supported with the same gaps as mint history.

#### Inputs and validation

- `poolId` required.
- `count` defaults to 50, clamp 1..200.
- `offset` defaults to 0.
- `successful` defaults to false (if supported).
- `includeTotal` defaults to true.

#### Primary data sources (existing)

- Ammdata activity for liquidity removes.
- Ammdata `pools` for token0/token1 ids.

#### New indices required (and where)

- Ammdata:
  - `pool_burns/v1/<pool_id>/<ts>/<seq> -> BurnEventRecord`.
  - `pool_burns/count/<pool_id> -> u64`.

Suggested `BurnEventRecord` fields mirror `MintEventRecord`.

#### Implementation plan (write path)

1. Detect `LiquidityRemove` activity per pool at index time.
2. Derive token amounts from activity deltas (base/quote deltas).
3. Derive `lp_token_amount` from the pool token burn amount for the tx.
4. Derive address from protostone pointer output if available; store scriptPubKey bytes.
5. Write `pool_burns` record and update count.

#### Implementation plan (read path)

1. Validate `poolId` and pagination params.
2. Read `pool_burns` index and map to `AmmBurnHistoryItem`.
3. Return `total` if `includeTotal` is true.

#### Missing getters to add (oylapi module)

- `get_pool_burn_history(pool_id, count, offset, include_total, successful?)`.

#### Caveats

- If LP token burn amount cannot be derived per tx, set `lpTokenAmount = "0"`.

---

### /get-pool-creation-history

#### Goal

Return pool creation events across all pools (global stream). Endpoint ignores `poolId` per current API spec.

#### Coverage

- Partially supported: `PoolCreate` activity exists per pool, and `pool_creation_info` stores creator and initial amounts, but a global creation stream and totals are missing.

#### Inputs and validation

- `count` defaults to 50, clamp 1..200.
- `offset` defaults to 0.
- `successful` defaults to false (if supported).
- `includeTotal` defaults to true.

#### Primary data sources (existing)

- Ammdata:
  - `pool_creation_info/v1/<pool>` for initial amounts and creator SPK.
  - `pools` for token0/token1 ids.
- Essentials:
  - `get_creation_record` for pool txid and creation timestamp.

#### New indices required (and where)

- Ammdata:
  - `pool_creations/v1/<ts>/<seq> -> CreationEventRecord` (global stream).
  - `pool_creations/count -> u64`.

Suggested `CreationEventRecord` fields:
- `txid`, `timestamp`, `pool_id`
- `token0_id`, `token1_id`
- `token0_amount`, `token1_amount`, `token_supply`
- `creator_spk` (Vec<u8>)
- `success` (bool)

#### Implementation plan (write path)

1. When a new pool is detected, write a `pool_creations` record:
   - Token ids from `pools` index.
   - Initial amounts and LP supply from `pool_creation_info`.
   - Creator address from protostone pointer output (LP receiver).
   - Timestamp/txid from pool creation record.
2. Update global count.

#### Implementation plan (read path)

1. Page through `pool_creations` index by prefix.
2. Map to `AmmCreationHistoryItem`:
   - `creatorAddress` from scriptPubKey (empty string if missing).
   - `tokenSupply` from creation info.
   - `timestamp` as ISO.
3. Return totals if `includeTotal` is true.

#### Missing getters to add (oylapi module)

- `get_pool_creation_history(count, offset, include_total, successful?)`.

#### Caveats

- If `poolId` is provided, it is ignored to match legacy behavior.

---

### Index definitions and data sources (new in 11-15)

#### `pool_swaps/v1/<pool>/<ts>/<seq>`

- Purpose: swap history per pool (for `/get-pool-swap-history`).
- Value: `SwapEventRecord`.
- Data source: activity indexing + pool defs.

#### `token_swaps/v1/<token>/<ts>/<seq>`

- Purpose: token swap history across pools (for `/get-token-swap-history`).
- Value: `SwapEventRecord`.
- Data source: derived from `pool_swaps` writes.

#### `pool_mints/v1/<pool>/<ts>/<seq>` / `pool_burns/v1/<pool>/<ts>/<seq>`

- Purpose: mint/burn history per pool.
- Value: `MintEventRecord` / `BurnEventRecord`.
- Data source: activity indexing + LP token delta extraction.

#### `pool_creations/v1/<ts>/<seq>`

- Purpose: global pool creation history.
- Value: `CreationEventRecord`.
- Data source: pool creation detection (`NewPoolInfo` + `pool_creation_info`).

#### Optional totals

- `*/count` keys for O(1) totals and `includeTotal` support.

---

### Overview: New getters after these 5 endpoints

#### New getters (oylapi module)

- `get_pool_swap_history(pool_id, count, offset, include_total, successful?)`.
- `get_token_swap_history(token_id, count, offset, include_total, successful?)`.
- `get_pool_mint_history(pool_id, count, offset, include_total, successful?)`.
- `get_pool_burn_history(pool_id, count, offset, include_total, successful?)`.
- `get_pool_creation_history(count, offset, include_total, successful?)`.

#### New getters (ammdata/essentials modules)

- Ammdata:
  - `get_pool_swaps(pool_id, offset, limit)`.
  - `get_token_swaps(token_id, offset, limit)`.
  - `get_pool_mints(pool_id, offset, limit)`.
  - `get_pool_burns(pool_id, offset, limit)`.
  - `get_pool_creations(offset, limit)`.
- Essentials:
  - `get_creation_record` (for pool txid + timestamp).
