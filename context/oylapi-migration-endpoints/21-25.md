# Oylapi Endpoints 21-25 Implementation Plan

This file covers endpoints 21-25 from `agent-context/oyl-api.ts`, building on the indices and rules established in:
- `context/oylapi-migration-endpoints/1-5.md`
- `context/oylapi-migration-endpoints/6-10.md`
- `context/oylapi-migration-endpoints/11-15.md`
- `context/oylapi-migration-endpoints/16-20.md`

Assumptions carried forward:
- Ammdata activity entries include `address_spk` and `success` and are used for swap/mint/burn/create history.
- Address SPK is derived from protostone pointer output, with vin fallback using lowest-value prevout.
- Subfrost indexes frBTC wrap/unwrap events and exposes module-owned getters.

---

### /get-all-unwrap-history

#### Goal
Return a global stream of frBTC unwrap events.

#### Coverage
- Partially supported: subfrost already defines `unwrap_events_all/v1/<ts>/<seq>`.
- Missing: subfrost getter for unwrap events (global) and oylapi handler.

#### Inputs and validation
- `count` defaults to 50, clamp 1..200.
- `offset` defaults to 0.
- `successful` defaults to false.
- `includeTotal` defaults to true.

#### Primary data sources
- Subfrost:
  - `unwrap_events_all/v1/<ts>/<seq> -> WrapEventRecord` (same record shape as wraps).

#### New indices required
- None (already defined in 16-20).

#### Implementation plan (read path)
1. Add `subfrost.get_unwrap_events_all(offset, limit, successful?)`.
2. Map to `WrapHistoryItem`:
   - `transactionId`, `amount`, `timestamp`, and `address` from SPK.
3. Return totals if `includeTotal` is true.

#### Missing getters to add (oylapi)
- `get_all_unwrap_history(count, offset, include_total, successful?)`.

---

### /get-total-unwrap-amount

#### Goal
Return total frBTC unwrap amount, optionally bounded by block height.

#### Coverage
- Not supported yet.

#### Inputs and validation
- `blockHeight` optional (inclusive height cutoff).
- `successful` defaults to false.

#### Primary data sources
- Subfrost (new cumulative index).

#### New indices required (subfrost)
- `unwrap_total_latest -> u128` (rolling total).
- `unwrap_total_by_height/<height> -> u128` (cumulative total at height).

#### Implementation plan (write path)
1. When indexing each block in subfrost, sum unwrap amounts in the block.
2. Update `unwrap_total_latest` (previous total + block delta).
3. If any unwraps were seen in the block, write `unwrap_total_by_height/<height> = total`.

#### Implementation plan (read path)
1. If `blockHeight` is not provided, return `unwrap_total_latest`.
2. If `blockHeight` is provided:
   - Read `unwrap_total_by_height/<height>` if exact match.
   - If missing, scan backward to the nearest <= height and return that total.
3. Return `totalAmount` as string.

#### Missing getters to add (oylapi)
- `get_total_unwrap_amount(block_height?, successful?)`.

#### Caveats
- If no unwraps exist yet, return `0`.

---

### /get-address-pool-creation-history

#### Goal
Return pool creation events for a specific address (across all pools).

#### Coverage
- Partially supported: activity entries include `PoolCreate` and `address_spk`.
- Missing: address-index for pool creation events.

#### Inputs and validation
- `address` required.
- `count` defaults to 50, clamp 1..200.
- `offset` defaults to 0.
- `successful` defaults to false.
- `includeTotal` defaults to true.

#### Primary data sources
- Ammdata:
  - `activity:v1` for `PoolCreate` events.
  - `pool_creation_info` for initial amounts and LP supply.
  - `pools` for base/quote ids.

#### New indices required (ammdata)
- `address_pool_creations/v1/<address_spk>/<ts>/<seq>/<pool> -> empty`.
- Optional count: `address_pool_creations/count/<address_spk> -> u64`.

#### Implementation plan (write path)
1. When writing `PoolCreate` activity, if `address_spk` is non-empty:
   - Write `address_pool_creations` key with `<address_spk>/<ts>/<seq>/<pool>`.

#### Implementation plan (read path)
1. Convert `address` to SPK bytes.
2. Page through `address_pool_creations` by prefix.
3. For each entry, fetch activity entry and pool defs.
4. Use `pool_creation_info` to fill `token0Amount`, `token1Amount`, `tokenSupply`.
5. Map to `AmmCreationHistoryItem` with `creatorAddress` from SPK.
6. Filter by `successful` if provided.

#### Missing getters to add (oylapi)
- `get_address_pool_creation_history(address, count, offset, include_total, successful?)`.

---

### /get-address-pool-mint-history

#### Goal
Return pool mint (liquidity add) events for a specific address (across all pools).

#### Coverage
- Partially supported: activity entries include `LiquidityAdd` + `address_spk`.
- Missing: address-index for pool mint events.

#### Inputs and validation
- `address` required.
- `count` defaults to 50, clamp 1..200.
- `offset` defaults to 0.
- `successful` defaults to false.
- `includeTotal` defaults to true.

#### Primary data sources
- Ammdata:
  - `activity:v1` for `LiquidityAdd`.
  - `pools` for base/quote ids.
  - `pool_lp_supply/latest` for `lpTokenAmount`.

#### New indices required (ammdata)
- `address_pool_mints/v1/<address_spk>/<ts>/<seq>/<pool> -> empty`.
- Optional count: `address_pool_mints/count/<address_spk> -> u64`.

#### Implementation plan (write path)
1. When writing `LiquidityAdd` activity, if `address_spk` is non-empty:
   - Write `address_pool_mints` key with `<address_spk>/<ts>/<seq>/<pool>`.

#### Implementation plan (read path)
1. Convert `address` to SPK bytes.
2. Page through `address_pool_mints` by prefix.
3. Load activity entry + pool defs.
4. Map to `AmmMintHistoryItem`:
   - Amounts from abs deltas.
   - `lpTokenAmount` from pool circulating supply (latest).
5. Filter by `successful` if provided.

#### Missing getters to add (oylapi)
- `get_address_pool_mint_history(address, count, offset, include_total, successful?)`.

---

### /get-address-pool-burn-history

#### Goal
Return pool burn (liquidity remove) events for a specific address (across all pools).

#### Coverage
- Partially supported: activity entries include `LiquidityRemove` + `address_spk`.
- Missing: address-index for pool burn events.

#### Inputs and validation
- `address` required.
- `count` defaults to 50, clamp 1..200.
- `offset` defaults to 0.
- `successful` defaults to false.
- `includeTotal` defaults to true.

#### Primary data sources
- Ammdata:
  - `activity:v1` for `LiquidityRemove`.
  - `pools` for base/quote ids.
  - `pool_lp_supply/latest` for `lpTokenAmount`.

#### New indices required (ammdata)
- `address_pool_burns/v1/<address_spk>/<ts>/<seq>/<pool> -> empty`.
- Optional count: `address_pool_burns/count/<address_spk> -> u64`.

#### Implementation plan (write path)
1. When writing `LiquidityRemove` activity, if `address_spk` is non-empty:
   - Write `address_pool_burns` key with `<address_spk>/<ts>/<seq>/<pool>`.

#### Implementation plan (read path)
1. Convert `address` to SPK bytes.
2. Page through `address_pool_burns` by prefix.
3. Load activity entry + pool defs.
4. Map to `AmmBurnHistoryItem`:
   - Amounts from abs deltas.
   - `lpTokenAmount` from pool circulating supply (latest).
5. Filter by `successful` if provided.

#### Missing getters to add (oylapi)
- `get_address_pool_burn_history(address, count, offset, include_total, successful?)`.

---

## Index definitions summary (new in 21-25)

### Ammdata
- `address_pool_creations/v1/<address_spk>/<ts>/<seq>/<pool>`
- `address_pool_mints/v1/<address_spk>/<ts>/<seq>/<pool>`
- `address_pool_burns/v1/<address_spk>/<ts>/<seq>/<pool>`

### Subfrost
- `unwrap_total_latest -> u128`
- `unwrap_total_by_height/<height> -> u128`
